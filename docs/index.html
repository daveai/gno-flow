<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>GNO Flow Monitor</title>
<link rel="icon" type="image/png" href="favicon.png">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
  *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

  html {
    overflow-y: scroll;
    color-scheme: dark;
    -webkit-text-size-adjust: 100%;
  }

  body {
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif;
    background: #0a0a0a;
    color: #d4d4d4;
    min-height: 100vh;
    display: flex;
    justify-content: center;
    padding: 32px 20px 48px;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
  }

  .container {
    width: 100%;
    max-width: 1080px;
  }

  /* ---- Header ---- */
  .header {
    display: flex;
    align-items: baseline;
    justify-content: space-between;
    border-bottom: 1px solid #1a1a1a;
    padding-bottom: 12px;
    margin-bottom: 0;
  }
  .header-left {
    display: flex;
    align-items: baseline;
    gap: 10px;
  }
  .title {
    font-size: 14px;
    font-weight: 700;
    color: #e8e8e8;
    text-transform: uppercase;
    letter-spacing: 1.4px;
  }
  .title-tag {
    font-family: 'JetBrains Mono', 'SF Mono', SFMono-Regular, Consolas, monospace;
    font-size: 10px;
    color: #3e6957;
    letter-spacing: 0.5px;
    border: 1px solid #2a3f34;
    padding: 1px 6px;
    border-radius: 3px;
  }
  .meta {
    font-family: 'JetBrains Mono', 'SF Mono', SFMono-Regular, Consolas, monospace;
    font-size: 10px;
    color: #555;
    text-align: right;
    line-height: 1.5;
  }
  .meta span { color: #777; }

  /* ---- Tabs ---- */
  .tabs {
    display: flex;
    border-bottom: 1px solid #1a1a1a;
  }
  .tab {
    padding: 10px 18px;
    cursor: pointer;
    color: #555;
    font-family: 'Inter', sans-serif;
    font-size: 11px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.8px;
    background: none;
    border: none;
    border-bottom: 2px solid transparent;
    transition: color 0.15s, border-color 0.15s;
    -webkit-tap-highlight-color: transparent;
  }
  .tab:hover { color: #999; }
  .tab.active {
    color: #e0e0e0;
    border-bottom-color: #3e6957;
  }

  /* ---- Table wrapper ---- */
  .table-wrap {
    display: none;
    min-height: 200px;
  }
  .table-wrap.active { display: block; }

  .table-scroll {
    overflow-x: auto;
  }

  table {
    width: 100%;
    min-width: 780px;
    border-collapse: collapse;
    font-size: 12px;
    table-layout: fixed;
  }
  thead { position: sticky; top: 0; z-index: 1; }
  th {
    text-align: left;
    padding: 8px 8px 6px;
    background: #0e0e0e;
    color: #555;
    font-size: 9px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.7px;
    border-bottom: 1px solid #1a1a1a;
    white-space: nowrap;
  }
  th.r { text-align: right; }
  th { cursor: pointer; user-select: none; }
  th::after { content: ''; display: inline-block; width: 8px; margin-left: 3px; font-size: 8px; vertical-align: middle; }
  th[data-sort="asc"]::after { content: '\25B2'; color: #3e6957; }
  th[data-sort="desc"]::after { content: '\25BC'; color: #3e6957; }

  td {
    padding: 5px 8px;
    border-bottom: 1px solid #131313;
    vertical-align: middle;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  tr:hover td { background: #111; }

  /* Column widths */
  col.c-rank   { width: 30px; }
  col.c-addr   { width: 96px; }
  col.c-label  { width: auto; }
  col.c-bal    { width: 86px; }
  col.c-in     { width: 86px; }
  col.c-out    { width: 86px; }
  col.c-net    { width: 96px; }
  col.c-count  { width: 54px; }
  col.c-chains { width: 76px; }

  /* Rank */
  .rank {
    font-family: 'JetBrains Mono', 'SF Mono', SFMono-Regular, Consolas, monospace;
    font-size: 10px;
    color: #333;
    text-align: right;
    padding-right: 10px;
  }

  /* Address */
  .addr {
    font-family: 'JetBrains Mono', 'SF Mono', SFMono-Regular, Consolas, monospace;
    font-size: 11px;
  }
  .addr a {
    color: #5a8fb0;
    text-decoration: none;
    transition: color 0.1s;
  }
  .addr a:hover {
    color: #7bb5d4;
    text-decoration: underline;
  }

  /* Label */
  .label { font-size: 11px; color: #888; }
  .label-text {
    background: #141414;
    border: 1px solid #1e1e1e;
    padding: 1px 5px;
    font-size: 10px;
    color: #999;
    border-radius: 2px;
    display: inline-block;
    max-width: 100%;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }
  .label-none { color: #1a1a1a; }

  /* Monospace right-aligned cells */
  .mono-r {
    font-family: 'JetBrains Mono', 'SF Mono', SFMono-Regular, Consolas, monospace;
    font-size: 11px;
    text-align: right;
  }

  /* Balance */
  .bal { color: #666; }

  /* Flow colors */
  .f-in { color: #1a9f5c; }
  .f-out { color: #b83a2e; }
  .f-net.pos { color: #1a9f5c; }
  .f-net.neg { color: #b83a2e; }

  /* Count */
  .count { color: #555; }

  /* Chains */
  .chains {
    font-size: 10px;
    color: #444;
    text-transform: lowercase;
  }
  .chain-dot {
    display: inline-block;
    width: 6px;
    height: 6px;
    border-radius: 50%;
    margin-right: 3px;
    vertical-align: middle;
    position: relative;
    top: -1px;
  }
  .chain-dot.ethereum { background: #627eea; }
  .chain-dot.gnosis { background: #3e6957; }

  /* Focus styles */
  .tab:focus-visible, .period-btn:focus-visible, .show-more-btn:focus-visible {
    outline: 2px solid #3e6957;
    outline-offset: -2px;
  }
  th:focus-visible { outline: 2px solid #3e6957; outline-offset: -2px; }
  a:focus-visible { outline: 2px solid #5a8fb0; outline-offset: 2px; border-radius: 2px; }

  .period-toggle {
    display: inline-flex;
    border: 1px solid #1e1e1e;
    border-radius: 3px;
    overflow: hidden;
    margin: 10px 0 2px;
  }
  .period-btn {
    background: none;
    border: none;
    color: #555;
    font-family: 'Inter', sans-serif;
    font-size: 10px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.6px;
    padding: 5px 14px;
    cursor: pointer;
    transition: color 0.15s, background 0.15s;
    -webkit-tap-highlight-color: transparent;
  }
  .period-btn:hover { color: #999; background: #111; }
  .period-btn.active {
    color: #e0e0e0;
    background: #1a2e23;
  }
  .period-btn + .period-btn { border-left: 1px solid #1e1e1e; }

  /* Show more button */
  .show-more-wrap {
    text-align: center;
    padding: 12px 0 4px;
  }
  .show-more-btn {
    background: none;
    border: 1px solid #1e1e1e;
    color: #666;
    font-family: 'Inter', sans-serif;
    font-size: 10px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.6px;
    padding: 6px 20px;
    cursor: pointer;
    border-radius: 3px;
    transition: color 0.15s, border-color 0.15s, background 0.15s;
    -webkit-tap-highlight-color: transparent;
  }
  .show-more-btn:hover {
    color: #999;
    border-color: #333;
    background: #111;
  }

  /* States */
  .state-msg {
    padding: 30px 10px;
    text-align: center;
    font-size: 11px;
    color: #444;
  }
  .state-msg.err { color: #b83a2e; }

  /* ---- Responsive ---- */
  @media (max-width: 768px) {
    body { padding: 16px 12px 32px; }

    .header {
      flex-direction: column;
      gap: 6px;
    }
    .meta { text-align: left; }

    .tab { padding: 10px 14px; }

    col.c-label { width: 120px; }
  }

  @media (max-width: 480px) {
    body { padding: 12px 8px 24px; }

    .title { font-size: 12px; letter-spacing: 1px; }
    .title-tag { font-size: 9px; }
    .meta { font-size: 9px; }

    .tab {
      padding: 10px 10px;
      font-size: 10px;
    }

    td { padding: 4px 6px; }
    th { padding: 6px 6px; }
  }
</style>
</head>
<body>

<main class="container">
  <header class="header">
    <div class="header-left">
      <h1 class="title">GNO Flow Monitor</h1>
      <span class="title-tag">ETH / GNO</span>
    </div>
    <div class="meta" id="meta">--</div>
  </header>

  <nav class="tabs" role="tablist" aria-label="Data views">
    <button class="tab active" role="tab" aria-selected="true" aria-controls="t7" data-target="t7">7-Day Flows</button>
    <button class="tab" role="tab" aria-selected="false" aria-controls="t30" data-target="t30">30-Day Flows</button>
    <button class="tab" role="tab" aria-selected="false" aria-controls="th" data-target="th">Top Holders</button>
    <button class="tab" role="tab" aria-selected="false" aria-controls="tbs" data-target="tbs">Buyers & Sellers</button>
  </nav>

  <div class="table-wrap active" id="t7" role="tabpanel" aria-labelledby="t7">
    <div class="state-msg" id="s7">Loading&#8230;</div>
  </div>
  <div class="table-wrap" id="t30" role="tabpanel" aria-labelledby="t30">
    <div class="state-msg" id="s30">Loading&#8230;</div>
  </div>
  <div class="table-wrap" id="th" role="tabpanel" aria-labelledby="th">
    <div class="state-msg" id="sh">Loading&#8230;</div>
  </div>
  <div class="table-wrap" id="tbs" role="tabpanel" aria-labelledby="tbs">
    <div class="period-toggle" id="bs-toggle" role="group" aria-label="Time period">
      <button class="period-btn active" data-period="30d" aria-pressed="true">30 Days</button>
      <button class="period-btn" data-period="7d" aria-pressed="false">7 Days</button>
    </div>
    <div id="bs-content">
      <div class="state-msg" id="sbs">Loading&#8230;</div>
    </div>
  </div>
</main>

<script>
(function () {
  var INITIAL_ROWS = 35;
  var EXPLORERS = {
    ethereum: 'https://etherscan.io/address/',
    gnosis: 'https://gnosisscan.io/address/'
  };

  function truncAddr(a) {
    return a && a.length >= 12 ? a.slice(0, 6) + '\u2026' + a.slice(-4) : a;
  }

  function explorerUrl(addr, chains) {
    var chain = chains && chains.length === 1 ? chains[0] : 'ethereum';
    return (EXPLORERS[chain] || EXPLORERS.ethereum) + addr;
  }

  function fmtGno(val, forceSign) {
    var n = parseFloat(val);
    if (isNaN(n)) return val;
    var abs = Math.abs(n);
    var formatted;
    if (abs >= 1e6) formatted = (abs / 1e6).toFixed(1) + 'M';
    else if (abs >= 1e3) formatted = (abs / 1e3).toFixed(1) + 'K';
    else if (abs >= 1) formatted = abs.toFixed(1);
    else if (abs > 0) formatted = abs.toFixed(2);
    else return '--';
    if (forceSign) {
      return (n >= 0 ? '+' : '\u2212') + formatted;
    }
    return (n < 0 ? '\u2212' : '') + formatted;
  }

  function fmtNum(n) {
    return Number(n).toLocaleString();
  }

  function esc(s) {
    var el = document.createElement('span');
    el.textContent = s;
    return el.innerHTML;
  }

  function chainDots(chains) {
    var out = '';
    for (var i = 0; i < chains.length; i++) {
      out += '<span class="chain-dot ' + esc(chains[i]) + '"></span>' + esc(chains[i]);
      if (i < chains.length - 1) out += ', ';
    }
    return out;
  }

  function sv(v) { return parseFloat(v) || 0; }

  function showMoreBtn(container) {
    var btn = container.querySelector('.show-more-btn');
    if (btn) {
      btn.addEventListener('click', function () {
        var extras = container.querySelectorAll('tr[data-extra]');
        for (var j = 0; j < extras.length; j++) {
          extras[j].style.display = '';
          extras[j].removeAttribute('data-extra');
        }
        this.parentNode.remove();
      });
    }
  }

  function resolveLabel(addr, labels) {
    var addrLower = (addr || '').toLowerCase();
    return (labels && labels[addrLower]) ? labels[addrLower] : '';
  }

  function labelHtml(label) {
    return label
      ? '<span class="label-text">' + esc(label) + '</span>'
      : '<span class="label-none">--</span>';
  }

  function rowPrefix(i, addr, label, chains) {
    var hidden = i >= INITIAL_ROWS ? ' style="display:none" data-extra="1"' : '';
    return '<tr' + hidden + '>' +
      '<td class="rank" data-sort="' + (i + 1) + '">' + (i + 1) + '</td>' +
      '<td class="addr" data-sort="' + esc(addr) + '"><a href="' + explorerUrl(addr, chains) + '" target="_blank" rel="noopener">' + truncAddr(addr) + '</a></td>' +
      '<td class="label" data-sort="' + esc(label) + '">' + labelHtml(label) + '</td>';
  }

  function rowSuffix(r) {
    return '<td class="mono-r count" data-sort="' + r.transfer_count + '">' + fmtNum(r.transfer_count) + '</td>' +
      '<td class="chains" data-sort="' + esc((r.chains || []).join(',')) + '">' + chainDots(r.chains || []) + '</td>' +
      '</tr>';
  }

  function flowCells(inVal, outVal, netVal, inRaw, outRaw, netRaw) {
    var netCls = parseFloat(netRaw) >= 0 ? 'pos' : 'neg';
    return '<td class="mono-r f-in" data-sort="' + sv(inRaw) + '">' + (inVal !== '--' ? '+' + esc(inVal) : '--') + '</td>' +
      '<td class="mono-r f-out" data-sort="' + sv(outRaw) + '">' + (outVal !== '--' ? '\u2212' + esc(outVal) : '--') + '</td>' +
      '<td class="mono-r f-net ' + netCls + '" data-sort="' + sv(netRaw) + '">' + esc(netVal) + '</td>';
  }

  function finishTable(h, rows, containerId) {
    h += '</tbody></table></div>';
    if (rows.length > INITIAL_ROWS) {
      h += '<div class="show-more-wrap"><button class="show-more-btn" data-container="' + containerId + '">' +
        'Show all ' + rows.length + ' addresses</button></div>';
    }
    var container = document.getElementById(containerId);
    container.innerHTML = h;
    showMoreBtn(container);
    makeSortable(container);
  }

  function buildTable(rows, containerId, labels) {
    var container = document.getElementById(containerId);
    if (!rows || rows.length === 0) {
      container.innerHTML = '<div class="state-msg">No data.</div>';
      return;
    }
    var h = '<div class="table-scroll"><table>' +
      '<colgroup>' +
      '<col class="c-rank"><col class="c-addr"><col class="c-label">' +
      '<col class="c-bal"><col class="c-in"><col class="c-out"><col class="c-net">' +
      '<col class="c-count"><col class="c-chains">' +
      '</colgroup>' +
      '<thead><tr>' +
      '<th class="r" scope="col">#</th>' +
      '<th scope="col">Address</th>' +
      '<th scope="col">Label</th>' +
      '<th class="r" scope="col">Balance</th>' +
      '<th class="r" scope="col">In</th>' +
      '<th class="r" scope="col">Out</th>' +
      '<th class="r" scope="col">Net</th>' +
      '<th class="r" scope="col">Txfrs</th>' +
      '<th scope="col">Chain</th>' +
      '</tr></thead><tbody>';

    for (var i = 0; i < rows.length; i++) {
      var r = rows[i];
      var addr = r.address || '';
      var label = resolveLabel(addr, labels);
      var bal = r.balance ? fmtGno(r.balance) : '--';

      h += rowPrefix(i, addr, label, r.chains) +
        '<td class="mono-r bal" data-sort="' + sv(r.balance) + '">' + esc(bal) + '</td>' +
        flowCells(
          r.inflow ? fmtGno(r.inflow) : '--',
          r.outflow ? fmtGno(r.outflow) : '--',
          fmtGno(r.net_flow, true),
          r.inflow, r.outflow, r.net_flow
        ) +
        rowSuffix(r);
    }

    finishTable(h, rows, containerId);
  }

  function buildHoldersTable(rows, containerId, labels) {
    var container = document.getElementById(containerId);
    if (!rows || rows.length === 0) {
      container.innerHTML = '<div class="state-msg">No data.</div>';
      return;
    }
    var h = '<div class="table-scroll"><table>' +
      '<colgroup>' +
      '<col class="c-rank"><col class="c-addr"><col class="c-label">' +
      '<col style="width:auto"><col class="c-count"><col class="c-chains">' +
      '</colgroup>' +
      '<thead><tr>' +
      '<th class="r" scope="col">#</th>' +
      '<th scope="col">Address</th>' +
      '<th scope="col">Label</th>' +
      '<th class="r" scope="col">Balance</th>' +
      '<th class="r" scope="col">Txfrs</th>' +
      '<th scope="col">Chain</th>' +
      '</tr></thead><tbody>';

    for (var i = 0; i < rows.length; i++) {
      var r = rows[i];
      var addr = r.address || '';
      var label = resolveLabel(addr, labels);
      var bal = r.balance ? fmtGno(r.balance) : '--';

      h += rowPrefix(i, addr, label, r.chains) +
        '<td class="mono-r bal" data-sort="' + sv(r.balance) + '">' + esc(bal) + '</td>' +
        rowSuffix(r);
    }

    finishTable(h, rows, containerId);
  }

  function buildBuySellTable(rows, containerId, labels) {
    var container = document.getElementById(containerId);
    if (!rows || rows.length === 0) {
      container.innerHTML = '<div class="state-msg">No data.</div>';
      return;
    }
    var h = '<div class="table-scroll"><table>' +
      '<colgroup>' +
      '<col class="c-rank"><col class="c-addr"><col class="c-label">' +
      '<col class="c-bal"><col class="c-in"><col class="c-out"><col class="c-net">' +
      '<col class="c-count"><col class="c-chains">' +
      '</colgroup>' +
      '<thead><tr>' +
      '<th class="r" scope="col">#</th>' +
      '<th scope="col">Address</th>' +
      '<th scope="col">Label</th>' +
      '<th class="r" scope="col">Balance</th>' +
      '<th class="r" scope="col">Buy</th>' +
      '<th class="r" scope="col">Sell</th>' +
      '<th class="r" scope="col">Net</th>' +
      '<th class="r" scope="col">Txfrs</th>' +
      '<th scope="col">Chain</th>' +
      '</tr></thead><tbody>';

    for (var i = 0; i < rows.length; i++) {
      var r = rows[i];
      var addr = r.address || '';
      var label = resolveLabel(addr, labels);
      var bal = r.balance ? fmtGno(r.balance) : '--';

      h += rowPrefix(i, addr, label, r.chains) +
        '<td class="mono-r bal" data-sort="' + sv(r.balance) + '">' + esc(bal) + '</td>' +
        flowCells(
          r.buy_volume ? fmtGno(r.buy_volume) : '--',
          r.sell_volume ? fmtGno(r.sell_volume) : '--',
          fmtGno(r.net, true),
          r.buy_volume, r.sell_volume, r.net
        ) +
        rowSuffix(r);
    }

    finishTable(h, rows, containerId);
  }

  function makeSortable(container) {
    var table = container.querySelector('table');
    if (!table) return;
    var thead = table.querySelector('thead');
    var tbody = table.querySelector('tbody');
    var headers = thead.querySelectorAll('th');

    for (var k = 0; k < headers.length; k++) {
      (function (colIdx) {
        headers[colIdx].addEventListener('click', function () {
          // Show all hidden rows first
          var extras = tbody.querySelectorAll('tr[data-extra]');
          for (var j = 0; j < extras.length; j++) {
            extras[j].style.display = '';
            extras[j].removeAttribute('data-extra');
          }
          var smBtn = container.querySelector('.show-more-btn');
          if (smBtn) smBtn.parentNode.remove();

          var current = this.getAttribute('data-sort') || '';
          for (var j = 0; j < headers.length; j++) headers[j].removeAttribute('data-sort');
          var dir = current === 'desc' ? 'asc' : 'desc';
          this.setAttribute('data-sort', dir);

          var rows = Array.prototype.slice.call(tbody.querySelectorAll('tr'));
          rows.sort(function (a, b) {
            var aVal = a.cells[colIdx].getAttribute('data-sort') || '';
            var bVal = b.cells[colIdx].getAttribute('data-sort') || '';
            var aNum = parseFloat(aVal);
            var bNum = parseFloat(bVal);
            var cmp;
            if (!isNaN(aNum) && !isNaN(bNum)) {
              cmp = aNum - bNum;
            } else {
              cmp = aVal.localeCompare(bVal);
            }
            return dir === 'asc' ? cmp : -cmp;
          });

          for (var j = 0; j < rows.length; j++) {
            tbody.appendChild(rows[j]);
            rows[j].cells[0].textContent = j + 1;
            rows[j].cells[0].setAttribute('data-sort', j + 1);
          }
        });
      })(k);
    }
  }

  // Tab switching
  var tabs = document.querySelectorAll('.tab');
  for (var i = 0; i < tabs.length; i++) {
    tabs[i].addEventListener('click', function () {
      for (var j = 0; j < tabs.length; j++) {
        tabs[j].classList.remove('active');
        tabs[j].setAttribute('aria-selected', 'false');
      }
      var wraps = document.querySelectorAll('.table-wrap');
      for (var j = 0; j < wraps.length; j++) wraps[j].classList.remove('active');
      this.classList.add('active');
      this.setAttribute('aria-selected', 'true');
      document.getElementById(this.dataset.target).classList.add('active');
    });
  }

  // Fetch data
  fetch('summary.json')
    .then(function (r) {
      if (!r.ok) throw new Error('HTTP ' + r.status);
      return r.json();
    })
    .then(function (data) {
      var synced = data.synced_at
        ? new Date(data.synced_at).toISOString().replace('T', ' ').slice(0, 19) + ' UTC'
        : '--';
      var total = data.total_transfers ? fmtNum(data.total_transfers) : '0';
      document.getElementById('meta').innerHTML =
        '<span>' + total + '</span> transfers &middot; synced ' + synced;

      var labels = data.labels || {};
      buildTable(data.top_7d, 't7', labels);
      buildTable(data.top_30d, 't30', labels);
      buildHoldersTable(data.top_holders, 'th', labels);

      // Buyers & Sellers with period toggle
      var bsData = { '30d': data.buyers_sellers_30d, '7d': data.buyers_sellers_7d };
      buildBuySellTable(bsData['30d'], 'bs-content', labels);

      var toggleBtns = document.querySelectorAll('#bs-toggle .period-btn');
      for (var t = 0; t < toggleBtns.length; t++) {
        toggleBtns[t].addEventListener('click', function () {
          for (var j = 0; j < toggleBtns.length; j++) {
            toggleBtns[j].classList.remove('active');
            toggleBtns[j].setAttribute('aria-pressed', 'false');
          }
          this.classList.add('active');
          this.setAttribute('aria-pressed', 'true');
          buildBuySellTable(bsData[this.dataset.period], 'bs-content', labels);
        });
      }
    })
    .catch(function (err) {
      document.getElementById('meta').textContent = 'Data unavailable';
      var ids = ['s7', 's30', 'sh', 'sbs'];
      for (var i = 0; i < ids.length; i++) {
        var el = document.getElementById(ids[i]);
        if (el) { el.className = 'state-msg err'; el.textContent = 'Error: ' + err.message; }
      }
    });
})();
</script>
</body>
</html>
